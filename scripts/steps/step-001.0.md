### Знакомство с тестированием

Неотъемлемой частью разработки масштабного приложения служит тестирование тех или иных частей этого приложения.
Есть даже методика разработки приложений, которая тесно связана с тестированием - разработка через тестирование. Возможно, 
вы знакомы с ней - <a href="https://en.wikipedia.org/wiki/Test-driven_development" target="_blank">Test-driven development (TDD)</a>.

Разработчики и сообщество Yii приложило много усилий, чтобы можно было максимально просто покрыть тестами необходимый код.

Раньше, когда создавали форму опрос, приходилось открывать страницу с формой, заполнять её выдуманными данными, проверять
результат. Добавляли код для вывода сообщения о успешном результате - опять открывали страницу с формой, заполняли её, проверяли 
результат. Добавляли поведение к форме - опять проверяли результат, открывая страницу с формой и заполняя её. Сохраняли результат в базе данных - 
приходилось проверять сохранились ли данные корректно. Возможно, вам приходится такое проделывать каждый раз,
когда разрабатывается тот или иной функционал. А когда приложение становится масштабным, уже боязно вносить изменения
в код потому, что далее приходится тратить много времени и сил, чтобы пройтись по некоторым страницам сайта и вручную
проверить, всё ли работает как требуется. И часто, спустя несколько дней, кто-нибудь сообщает, что то что, когда-то работало,
перестало работать. И опять тратиться время на выяснение причины неисправности, а так как изменения вносились несколько
дней назад, то поиск истиной причины становится мукой. А бывает причина неисправности определяется неверно и в результате 
добавляется "костыль", который исправляет проблему. 

Может вы к этому привыкли и вас всё устраивает. Но что, если про это всё забыть и использовать всего лишь одну команду,
которая выполнит все проверки в самых нежных и уязвимых местах приложения:

```
codecept run
```

Всё! Больше ничего. Запустив команду, после очередного изменения кода и не увидев ни одной ошибки в результатах, вы можете 
со спокойной душой сообщить всем, что всё работает, как того требует техническое задание.

В этой главе посмотрим, что скрывается под командой `codecept run`. 

Для подготовки кода в соответствии с этой главой, выполните команду из директории yii2-tutorial:

```
git checkout -f step-1.0
```

<p class="alert alert-info">Работая под Windows вместо стандартной командной строки cmd удобнее использовать другой 
интерпретатор, который использует подсветку кода. Например <a href="http://www.conemu.ru/" target="_blank">ConEmu</a>, он
идёт в комплекте с <a href="http://open-server.ru/" target="_blank">OpenServer</a> или 
<a href="http://gooseberrycreative.com/cmder/" target="_blank">Cmder</a>. Если у вас возникли проблемы с кодировкой 
в командной строке, то попробуйте выполнить в ней команду "chcp 65001".
</p>

#### Codeception

Yii для тестирование кода предоставляет систему <a href="http://codeception.com/" target="_blank">Codeception</a>.
Codeception основан на php фреймворке для тестирования <a href="https://phpunit.de/" target="_blank">PHPUnit</a>.
Вся настройка Codeception сводится к следующим шагам:

- создайте директорию `codecept`, где посчитаете нужным (не внутри учебника)
- создайте в этой директории `composer.json` со следующим содержанием:
```
{
    "require": {
        "codeception/codeception": "*",
        "codeception/verify": "*",
        "codeception/specify": "*"
    }
}
```
- запустите команду `composer install` из этой директории
- после установки всех зависимостей, настройте переменную 
<a href="https://ru.wikipedia.org/wiki/PATH_%28%D0%BF%D0%B5%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D0%B0%D1%8F%29" target="_blank">
PATH</a> на директории `codecept\vendor\bin\`, чтобы команда `codecept` была доступна глобально.

Теперь можно выполнить команду `codecept -V`, чтобы увидеть версию Codeception и убедиться, что он успешно установлен.

#### Виды тестов

Codeception поддерживает следующие виды тестов:

- Модульные тесты (Unit), которые проверяют код, который выполняется в изоляции.
- Функциональные тесты (Functional), которые проверяют код, через эмуляцию браузера.
- Приёмочные тесты (Acceptance), которые проверяют код, через браузер.

Все тесты располагаются в `\yii2-tutorial\yii2-app-advanced\tests\codeception`. Как и структура Advanced шаблона Yii, 
тесты также разделены для гибкости на backend и frontend. Только настройки вынесены в отдельную директорию `config`.

Кстати для некоторых тестов необходимо соединение с базой данных. Придётся извлекать, записывать данные, а иногда и удалять.
Понятное дело, что основную базу лучше в этом случае не использовать. Нужна тестовая. Используя миграции, не составит труда
создать копию основной базы данных.

Поэтому в `yii2-app-advanced/tests/codeception/config/config.php` указана:

```php
'db' => [
    'dsn' => 'sqlite:' . dirname(__FILE__) .'/../../sqlite-test.db',
],
```

К этой базе данных применены все миграции, которые использовались и для основной. Чтобы это выполнить, понадобилось
вызвать `php yii migrate` из `yii2-app-advanced/tests/codeception/bin`.

Теперь вернёмся к структуре директорий. Открыв `yii2-app-advanced/tests/codeception/backend`, можно обнаружить

```
[_output]
[acceptance]
[functional]
[unit]
```

`acceptance, functional, unit` директории, которые хранят тесты в зависимости от их видов. `_output` - это директория, в 
которую будет попадать результат эмуляции браузера (html код страницы) для функциональных тестов, в случае ошибки.

В Codeception есть понятие "Исполнители тестов". Для чего они? Из названия понятно. Перед их созданием 
необходимо произвести их инициализацию. В директории `tests/codeception/frontend` 
необходимо выполнить `codecept build`. Создадутся файлы:

```
yii2-app-advanced/tests/codeception/frontend/acceptance/AcceptanceTester.php
yii2-app-advanced/tests/codeception/frontend/functional/FunctionalTester.php
yii2-app-advanced/tests/codeception/frontend/unit/UnitTester.php
```

которые и будут являться исполнителями. В последствии, тоже самое нужно проделать и для backend части.

#### Запуск тестов

Можно попробовать для frontend запустить тесты. В `yii2-tutorial\yii2-app-advanced\tests\codeception\frontend\`
запустим на выполнение все функциональные тесты:

```php
codecept run functional

Time: 3 seconds, Memory: 29.25Mb
OK (6 tests, 49 assertions)
```

Выполнив эту команду, вы наверное ничего и не почувствовали. Но обратите внимание на время выполнения - **3 секунды**.
За эти три секунды `FunctionalTester` успел посетить страницу <a href="/yii2-app-advanced/frontend/web/index.php?r=site/about" target="_blank">
о нас</a>, <a href="/yii2-app-advanced/frontend/web/index.php?r=site/contract" target="_blank">обратная связь</a>,
<a href="/yii2-app-advanced/frontend/web/index.php?r=site/index" target="_blank">домашнюю страницу</a> и проверить
что они работают без ошибок. В эти 3 секунды исполнитель побывал на 
<a href="/yii2-app-advanced/frontend/web/index.php?r=site/signup" target="_blank">странице регистрации</a>,
<a href="/yii2-app-advanced/frontend/web/index.php?r=site/login" target="_blank">аутентификации</a>, 
и на <a href="/yii2-app-advanced/frontend/web/index.php?r=site/login" target="_blank">странице опроса</a>, проверил эти 
формы, на корректность ввода данных. Исполнитель проверил работоспособность поведения accessOnce, которое было создано ранее.
В сумме за три секунды исполнитель выполнил 6 тестов, в которых присутствовало 49 проверок. 

Представьте сколько бы времени у вас ушло, если бы это выполняли самостоятельно через браузер. И запустив 

```php
codecept run functional
```

после очередного рефакторинга кода, можно с уверенностью сказать, корректно ли работают эти части сайта. Больше не нужно
бродить по сайту в поисках "А не поломал ли я что-нибудь?". В этом и есть одна из приятных особенностей тестирования.

Также можно попробовать запустить модульные(юнит, unit) тесты:

```php
codecept run unit

Time: 8.29 seconds, Memory: 17.00Mb
OK (9 tests, 25 assertions)
```

А вот для приёмочных, вы обнаружите ошибки.

```php
codecept run acceptance

FAILURES!
Tests: 5, Assertions: 0, Errors: 5.
```

Всё дело в том, что для работы приёмочных тестов нужен браузер. Окружение для Codeception в Yii настроено таким образом,
что используется <a href="http://codeception.com/docs/modules/PhpBrowser" target="_blank">PhpBrowser</a>. 

```
// Файл yii2-app-advanced/tests/codeception/frontend/acceptance.suite.yml
modules:
    enabled:
        - PhpBrowser
        - tests\codeception\common\_support\FixtureHelper
    config:
        PhpBrowser:
            url: http://localhost:8080
```

Т.е. настраивать ничего не нужно, остаётся изменить только путь к нашему сайту с http://localhost:8080 на 
http://localhost:8888/yii2-app-advanced/. Сделайте это.
 
Вместо PhpBrowser может быть выбран любой другой браузер (Chrome, FF, IE или другой) под управлением специального 
веб-драйвера, например <a href="http://www.seleniumhq.org/" target="_blank">Selenium</a>. Смена PhpBrowser браузера 
позволит тестировать поведения в браузере, связанные с javascripts.

А сейчас, когда PhpBrowser настроен, можно пробовать запускать и приёмочные тесты.

Запуск отдельных тестов, сокращает время ожидания выполнения. Codeception поддерживает: 

- запуск всех тестов;
- запуск тестов по видам;
- запуск отдельных тестов.
 
Например, для `yii2-app-advanced/tests/codeception/frontend` можно выполнить:

```
codecept run
codecept run functional
codecept run functional functional\InterviewCept.php 
```

В разделе [Сохранение реляционных данных](/scripts/index.php?c=step-1.3) присутствует пример как проверить работоспособность
формы с помощью тестирования.

#### Дополнительная информация для самостоятельного ознакомления:

- <a href="https://ru.wikipedia.org/wiki/%D0%AD%D0%BA%D1%81%D1%82%D1%80%D0%B5%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5" target="_blank">Экстремальное программирование</a>.
- <a href="http://codeception.com/docs/01-Introduction" target="_blank">Руководство по Codeception</a>.
- <a href="https://phpunit.de/manual/current/en/index.html" target="_blank">Руководство по PHPUnit</a>.